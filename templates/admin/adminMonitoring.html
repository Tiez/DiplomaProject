{% extends "admin/admin.html" %}
{% block title %}System{% endblock %}

{% block style %}
<style>
    body {
        background-color: #121212;
        color: #f0f0f0;
        font-family: 'Lucida Sans', sans-serif;
    }

    h2 {
        font-size: 24px;
        margin-bottom: 20px;
        color: #e6e6e6;
    }

    .monitor-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        align-items: flex-start;
        justify-content: space-between;
        margin: 20px 10px;
    }

    .system-stats {
        background-color: #1e1e1e;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        flex: 1.5;
        min-width: 350px;
    }

    .system-stats p {
        margin: 10px 0;
        font-weight: bold;
        color: #dcdcdc;
    }

    .chart-container {
        margin-bottom: 20px;
    }

    .workers-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex: 1;
        min-width: 350px;
    }

    .worker-card {
        background-color: #1e1e1e;
        border-radius: 10px;
        padding: 15px;
        border-left: 4px solid #2d8521;
        color: #ccc;
        transition: transform 0.2s;
    }

    .worker-card:hover {
        transform: translateY(-3px);
        background-color: #262626;
    }

    .worker-card span {
        color: #fff;
        font-weight: bold;
    }

    .queue-container {
        background-color: #1e1e1e;
        border-radius: 12px;
        padding: 20px;
        flex: 0.8;
        min-width: 300px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    #pendingList {
        list-style-type: none;
        padding: 0;
        margin: 10px 0;
        max-height: 300px;
        overflow-y: auto;
        color: #aaa;
    }

    #pendingList li {
        margin: 4px 0;
        padding: 6px;
        border-radius: 6px;
        background-color: #2a2a2a;
        font-size: 14px;
    }

    canvas {
        background-color: #2a2a2a;
        border-radius: 8px;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<h2>System Monitor</h2>

<div class="monitor-container">

    <!-- CPU and Memory section -->
    <div class="system-stats">
        <div class="chart-container">
            <p>CPU Usage: <span id="cpu">--</span>%</p>
            <canvas id="cpuChart" width="400" height="80"></canvas>
        </div>

        <div class="chart-container">
            <p>Memory Usage: <span id="memory">--</span>%</p>
            <canvas id="memoryChart" width="400" height="80"></canvas>
        </div>
    </div>

    <!-- Worker statuses -->
    <div class="workers-container">
        {% for i in range(worker_count) %}
        <div class="worker-card">
            <p><strong>Worker {{ i }}</strong></p>
            <p>Status: <span id="worker-{{ i }}-status">--</span></p>
            <p>Submission ID: <span id="worker-{{ i }}-subid">--</span></p>
        </div>
        {% endfor %}
    </div>

    <!-- Queue section -->
    <div class="queue-container">
        <p>Pending Submissions in Queue: <span id="queueLen">--</span></p>
        <ul id="pendingList"></ul>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const maxDataPoints = 40;
    let cpuData = [], memoryData = [], labels = [];

    const cpuCtx = document.getElementById('cpuChart').getContext('2d');
    const memoryCtx = document.getElementById('memoryChart').getContext('2d');

    const cpuChart = new Chart(cpuCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'CPU %',
                data: cpuData,
                borderColor: '#2d8521',
                backgroundColor: 'rgba(45, 133, 33, 0.2)',
                borderWidth: 3,
                pointRadius: 0,
                fill: true,
                tension: 0.2
            }]
        },
        options: {
            responsive: true,
            animation: false,
            plugins: { legend: { display: false } },
            scales: { y: { min: 0, max: 100, ticks: { stepSize: 20 } }, x: { display: false } }
        }
    });

    const memoryChart = new Chart(memoryCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Memory %',
                data: memoryData,
                borderColor: '#4da6ff',
                backgroundColor: 'rgba(77, 166, 255, 0.2)',
                borderWidth: 3,
                pointRadius: 0,
                fill: true,
                tension: 0.2
            }]
        },
        options: {
            responsive: true,
            animation: false,
            plugins: { legend: { display: false } },
            scales: { y: { min: 0, max: 100, ticks: { stepSize: 20 } }, x: { display: false } }
        }
    });

    function updateSystemCharts() {
        fetch("/admin/system_data")
            .then(res => res.json())
            .then(data => {
                const now = new Date().toLocaleTimeString();
                const cpu = data.cpu || 0;
                const memory = data.mem || data.memory || 0;

                document.getElementById("cpu").innerText = cpu.toFixed(1);
                document.getElementById("memory").innerText = memory.toFixed(1);
                document.getElementById("queueLen").innerText = data.queue.toFixed(1);

                Object.keys(data.workerStats).forEach(workerId => {
                    const statusEl = document.getElementById(`worker-${workerId}-status`);
                    const subIdEl = document.getElementById(`worker-${workerId}-subid`);
                    const status = data.workerStats[workerId];
                    if (status.startsWith("idle")) {
                        statusEl.innerText = "Idle";
                        subIdEl.innerText = "--";
                    } else {
                        statusEl.innerText = "Processing";
                        subIdEl.innerText = status;
                    }
                });

                const pendingList = document.getElementById("pendingList");
                pendingList.innerHTML = "";
                data.pending_submissions.forEach(job => {
                    const li = document.createElement("li");
                    li.textContent = `Submission ${job[0]} (Problem ${job[2]})`;
                    pendingList.appendChild(li);
                });

                labels.push(now);
                cpuData.push(cpu);
                memoryData.push(memory);
                if (labels.length > maxDataPoints) {
                    labels.shift();
                    cpuData.shift();
                    memoryData.shift();
                }

                cpuChart.update();
                memoryChart.update();
            })
            .catch(err => console.error("Error fetching system data:", err));
    }

    setInterval(updateSystemCharts, 500);
    updateSystemCharts();
</script>
{% endblock %}