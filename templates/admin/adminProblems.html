{% extends "admin/admin.html" %}
{% block title %}Problems{% endblock %}

{% block style %}
<style>
    #searchButton {
        background-color: #1e1e1e;
        color: aliceblue;
        border-radius: 8px;
        padding: 8px;
    }

    #searchBar {
        margin: 10px 0 0 0;
        width: 600px;
        height: 24px;
        border-radius: 8px;
        background-color: #1e1e1e;
        border: solid #2a2a2a 2px;
        color: aliceblue;
        padding: 3px;
    }

    #footer {
        align-items: center;
        height: 5px;
        background-color: #2a2a2a;
        color: #e6e6e6;
        font-weight: bold;
        margin: 0px 0 20px;
        padding: 10px;
        border-radius: 0 0 12px 12px;
    }

    /* Header row */
    #header {
        display: grid;
        grid-template-columns: 1fr 2fr 2fr 3fr 2fr;
        align-items: center;
        gap: 10px;
        background-color: #2a2a2a;
        color: #e6e6e6;
        font-weight: bold;
        margin: 20px 0 0;
        padding: 10px;
        border-radius: 12px 12px 0 0;
        font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
    }

    /* Each row */
    #listItem {
        display: grid;
        grid-template-columns: 1fr 2fr 2fr 3fr 2fr;
        align-items: center;
        gap: 10px;
        background-color: #1e1e1e;
        color: #ddd;
        padding: 10px;
        margin: 0px 0 10px;
    }

    /* Container for all rows */
    #list-container {
        font-family: Arial, sans-serif;
        overflow: hidden;
        margin-top: 10px;
    }

    /* Column text */
    .ID,
    .TITLE,
    .EXP,
    .DESC,
    .ACT {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Buttons */
    .actions {
        display: flex;
        justify-content: center;
        gap: 8px;
    }

    #edit,
    #del {
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 14px;
        text-align: center;
        color: #fff;
        text-decoration: none;
        flex: 1;
    }

    #edit {
        background-color: #2d8521;
    }

    #del {
        background-color: #852121;
    }

    /* Add Problem button */
    .add-btn {
        font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
        display: inline-block;
        background-color: #2d8521;
        color: #f0f0f0;
        font-size: 17px;
        padding: 6px 12px;
        margin: 10px 0;
        border-radius: 6px;
        text-decoration: none;
    }

    button {
        box-shadow: none;
        border: none;
    }
</style>
{% endblock %}

{% block content %}
<div style="margin: 10px;">
    {% if add or edits %}
    ID {{ problem_id }}

    <form method="POST">
        <input type="text" id="title" name="title" placeholder="Problem Title"
            value="{{ problem.title if problem else '' }}" required><br>
        <textarea id="description" name="description" placeholder="Description" rows="4" cols="50"
            required>{{ problem.description if problem else '' }}</textarea><br>
        <textarea id="example" name="example" placeholder="Examples" rows="4" cols="50"
            required>{{ problem.examples if problem else '' }}</textarea><br>
        <textarea id="prefix" name="prefix" placeholder="Prefix" rows="4" cols="50"
            required>{{ problem.prefix if problem else '' }}</textarea><br>
        <textarea id="constraints" name="constraints" placeholder="Constraints" rows="4" cols="50"
            required>{{ problem.constraints if problem else '' }}</textarea><br>

        {% if add %}
        <button type="submit">Add Problem</button>
        {% else %}
        <button type="submit">Edit Problem</button><br>
        {% endif %}
    </form>




    {% endif %}

    {% if not add and not edits %}
    <h2
        style="font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;">
        Problems
    </h2>
    <div id="top">
        <a class="add-btn" href="{{ url_for('add_problem') }}">Add New Problem</a>

        <div style="font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
                    font-size: 20px;">
            search:
        </div>
        <input placeholder="Enter Title" id="searchBar" type="text">
        <button id="searchButton">Search</button>
    </div>

    <div id="header">
        <div class="ID">ID</div>
        <div class="TITLE">Title</div>
        <div class="EXP">Examples</div>
        <div class="DESC">Description</div>
        <div class="ACT">Actions</div>
    </div>

    <div id="list-container">
        {% for p in problems %}
        <div id="listItem">
            <div class="ID">{{ p.id }}</div>
            <div class="TITLE">{{ p.title }}</div>
            <div class="EXP">{{ p.examples }}</div>
            <div class="DESC">{{ p.description }}</div>
            <div class="actions">
                <a id="edit" href="{{ url_for('edit_problem', id=p.id) }}">Edit</a>
                <a id="del" href="{{ url_for('delete_problem', id=p.id) }}">Delete</a>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="footer"></div>
</div>
{% endif %}


{% if edits %}
<h1>Problem Testcases</h1>
{% if not testcases[0] %}
{{id}}
{{testcases}}
<a href="{{ url_for('admin_testcases', problem_id=problem_id) }}">Add test case</a>

{% else %}
<a href="{{ url_for('admin_testcases', problem_id=testcases[0]['problem_id']) }}">Add test case</a>
{% endif %}

<table border="1">
    <tr>
        <th>ID</th>
        <th>Input</th>
        <th>Output</th>
    </tr>
    {% for t in testcases %}
    <tr>
        <td>{{t.id}}</td>
        <td>{{t.input}}</td>
        <td>{{t.expected}}</td>
    </tr>
    {% endfor %}
</table>
{% if not testcases %}
<h1>No Test cases </h1>
{% endif %}












<script>

    window.onload = function () {
        refreshSlots("{{ problem_id }}"); // pass problem_id from Jinja

    }
    document.getElementById("searchButton").addEventListener("click", function (e) {
        e.preventDefault(); // prevent refresh

        let query = document.getElementById("searchBar").value.toLowerCase();
        let items = document.querySelectorAll("#list-container #listItem");

        items.forEach(item => {
            let title = item.querySelector(".TITLE").innerText.toLowerCase();
            if (title.includes(query)) {
                item.style.display = "grid"; // keep grid
            } else {
                item.style.display = "none";
            }
        });

        document.getElementById("searchBar").value = "";
    });
    async function refreshSlots(problemId) {
        try {

            const res = await fetch(`/problem/${problemId}`, { cache: "no-store" });
            if (!res.ok) throw new Error("Failed to fetch problem " + problemId);
            const payload = await res.json();

            const p = payload.problem || {};
            // Get form fields
            const title = document.getElementById("title");
            const desc = document.getElementById("description");
            const example = document.getElementById("example");
            const constraints = document.getElementById("constraints");
            const prefix = document.getElementById("prefix");

            // Fill values
            if (title) title.value = p.title || "";
            if (desc) desc.value = p.description || "";
            if (example) example.value = p.examples || "";
            if (constraints) constraints.value = p.constraints || "";
            if (prefix) prefix.value = p.prefix || "";

        } catch (err) {
            console.error("error:", err);
        }
    }
</script>
{% endif %}
{% endblock %}