{% extends "admin/admin.html" %}
{% block title %}Problems{% endblock %}

{% block style %}
<style>
    /* Testcase header row */
    #header-testcase {
        display: grid;
        grid-template-columns: 0.2fr 1.5fr 1.5fr;
        align-items: center;
        gap: 10px;
        background-color: #2a2a2a;
        color: #e6e6e6;
        font-weight: bold;
        margin: 20px 0 0;
        padding: 10px;
        border-radius: 12px 12px 0 0;
        font-family: 'Lucida Sans', sans-serif;
    }

    /* Each testcase row */
    #listItem-testcase {
        display: grid;
        grid-template-columns: 0.2fr 1.5fr 1.5fr;
        align-items: center;
        gap: 10px;
        background-color: #1e1e1e;
        color: #ddd;
        padding: 10px;
        margin: 0 0 4px;
        border-radius: 3px;
    }

    /* Scrollable container if many testcases */
    #list-container-testcase {
        max-height: 500px;
        overflow-y: auto;
    }

    /* Preserve formatting inside pre tags */
    #listItem-testcase pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        margin: 0;
        font-family: monospace;
        color: #f0f0f0;
    }

    /* Form container */
    #formContainer {
        display: flex;
        flex-direction: column;
        gap: 6px;
        background-color: #2a2a2a;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        max-width: 700px;
        margin: 20px auto
    }

    /* Labels */
    #formContainer label {
        font-family: 'Lucida Sans', sans-serif;
        font-size: 13px;
        font-weight: 600;
        color: #f0f0f0;
        margin-bottom: 4px;
    }

    /* Inputs and textareas */
    .textSection {
        border-radius: 8px;
        background-color: #1e1e1e;
        color: #f0f0f0;
        border: 1px solid #444;
        padding: 10px;
        font-size: 14px;
        font-family: 'Lucida Sans', sans-serif;
        transition: border 0.2s, box-shadow 0.2s;
        width: 97%;
        resize: none;
    }

    .textSection:focus {
        outline: none;
        border: 1px solid #2d8521;
        box-shadow: 0 0 8px rgba(45, 133, 33, 0.5);
        background-color: #262626;
    }

    /* Buttons */
    #formContainer button {
        background-color: #2d8521;
        color: #fff;
        padding: 10px 16px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s, transform 0.2s;
    }

    #formContainer button:hover {
        background-color: #1f5e17;
        transform: translateY(-2px);
    }

    /* Placeholders */
    .textSection::placeholder {
        color: #aaa;
        font-style: italic;
    }

    /* Responsive for smaller screens */
    @media screen and (max-width: 768px) {
        #formContainer {
            width: 90%;
            padding: 15px;
        }

        #formContainer button {
            font-size: 14px;
        }
    }

    #searchButton {
        background-color: #1e1e1e;
        color: aliceblue;
        border-radius: 8px;
        padding: 8px;
    }

    #searchBar {
        margin: 10px 0 0 0;
        width: 600px;
        height: 24px;
        border-radius: 8px;
        background-color: #1e1e1e;
        border: solid #2a2a2a 2px;
        color: aliceblue;
        padding: 3px;
    }

    #footer {
        align-items: center;
        height: 5px;
        background-color: #2a2a2a;
        color: #e6e6e6;
        font-weight: bold;
        margin: 0px 0 20px;
        padding: 10px;
        border-radius: 0 0 12px 12px;
    }

    /* Header row */
    #header {
        display: grid;
        grid-template-columns: 0.2fr 2fr 6fr 2fr 1fr 1fr;
        align-items: center;
        gap: 10px;
        background-color: #2a2a2a;
        color: #e6e6e6;
        font-weight: bold;
        margin: 20px 0 0;
        padding: 10px;
        border-radius: 12px 12px 0 0;
        font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
    }

    /* Each row */
    #listItem {
        display: grid;
        grid-template-columns: 0.2fr 2fr 6fr 2fr 1fr 1fr;
        align-items: center;
        gap: 10px;
        background-color: #1e1e1e;
        color: #ddd;
        padding: 10px;
        margin: 0px 0 10px;
    }

    /* Container for all rows */
    #list-container {
        font-family: Arial, sans-serif;
        overflow: hidden;
        margin-top: 10px;
    }

    /* Column text */
    .ID,
    .TITLE,
    .EXP,
    .DESC,
    .ACT {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Buttons */
    .actions {
        display: flex;
        justify-content: center;
        gap: 8px;
    }

    #edit,
    #del {
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 14px;
        text-align: center;
        color: #fff;
        text-decoration: none;
        flex: 1;
    }

    #edit {
        background-color: #2d8521;
    }

    #del {
        background-color: #852121;
    }

    /* Add Problem button */
    .add-btn {
        font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
        display: inline-block;
        background-color: #2d8521;
        color: #f0f0f0;
        font-size: 17px;
        padding: 6px 12px;
        margin: 10px 0;
        border-radius: 6px;
        text-decoration: none;
    }

    button {
        border: none;
    }

    .difficulty {
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: bold;
        text-align: center;
        width: fit-content;
    }

    .easy {
        color: #2d8521;
        /* green */
    }

    .medium {
        color: #f0a500;
        /* orange */
    }

    .hard {
        color: #852121;
        /* red */
    }
</style>
{% endblock %}

{% block content %}
<div style="margin: 10px;">
    {% if add or edits %}

    <div style="display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap;">
        <!-- Problem Edit Form -->
        <form method="POST" style="flex: 2; min-width: 300px;">
            <div id="formContainer">
                <label>Title | ID {{ problem_id }}</label>
                <input class="textSection" type="text" id="title" name="title" placeholder="Problem Title"
                    value="{{ problem.title if problem else '' }}" required>

                <label>Description</label>
                <textarea class="textSection" id="description" name="description" placeholder="Description" rows="4"
                    required></textarea>

                <label>Example</label>
                <textarea class="textSection" id="example" name="example" placeholder="Examples" rows="4"
                    required></textarea>

                <label>Prefix</label>
                <textarea class="textSection" id="prefix" name="prefix" placeholder="Prefix" rows="4"
                    required></textarea>

                <label>Constraints</label>
                <textarea class="textSection" id="constraints" name="constraints" placeholder="Constraints" rows="4"
                    required></textarea>

                <div style="display: flex; gap: 10px; margin: 10px 0;">
                    <label>Easy</label>
                    <input type="radio" name="diff" value="Easy" required>
                    <label>Medium</label>
                    <input type="radio" name="diff" value="Medium" required>
                    <label>Hard</label>
                    <input type="radio" name="diff" value="Hard" required>
                </div>

                <label>Tags (comma-separated)</label>
                <input class="textSection" type="text" id="tags" name="tags" placeholder="e.g. Array,String,Math"
                    value="{{ problem.tags if problem else '' }}">

                {% if add %}
                <button type="submit">Add Problem</button>
                {% else %}
                <button type="submit">Edit Problem</button>
                {% endif %}
            </div>
        </form>

        <!-- Testcase Table -->
        {% if edits %}
        <div style="flex: 1; min-width: 300px;">
            <h1>Problem Testcases</h1>

            {% if testcases %}
            <a class="add-btn" href="{{ url_for('admin_testcases', problem_id=testcases[0]['problem_id']) }}">Add
                Testcase</a>

            <div id="header-testcase">
                <div class="ID">ID</div>
                <div class="DESC">Input</div>
                <div class="DESC">Output</div>
            </div>

            <div id="list-container-testcase">
                {% for t in testcases %}
                <div id="listItem-testcase">
                    <div class="ID">{{ t.id }}</div>
                    <div class="DESC">
                        <pre>{{ t.input }}</pre>
                    </div>
                    <div class="DESC">
                        <pre>{{ t.expected }}</pre>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% else %}
            <h2>No Testcases</h2>
            <a class="add-btn" href="{{ url_for('admin_testcases', problem_id=problem_id) }}">Add Testcase</a>
            {% endif %}
        </div>
        {% endif %}
    </div>

    {% endif %}

    {% if not add and not edits %}
    <h2
        style="font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;">
        Problems
    </h2>
    <div id="top">
        <a class="add-btn" href="{{ url_for('add_problem') }}">Add New Problem</a>

        <div style="font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
                    font-size: 20px;">
            search:
        </div>
        <input placeholder="Enter Title" id="searchBar" type="text">
        <button id="searchButton">Search</button>
    </div>

    <div id="header">
        <div class="ID">ID</div>
        <div class="TITLE">Title</div>

        <div class="DESC">Description</div>
        <div class="DESC">Tags</div>
        <div class="DESC">Difficulty</div>
        <div class="ACT">Actions</div>
    </div>

    <div id="list-container">
        {% for p in problems %}
        <div id="listItem">
            <div class="ID">{{ p.id }}</div>
            <div class="TITLE">{{ p.title }}</div>
            <div class="DESC">{{ p.description }}</div>
            <div class="DESC">{{ p.tags if p.tags else '' }}</div>
            <div
                class="difficulty {% if p.diff == 'Easy' %}easy{% elif p.diff == 'Medium' %}medium{% elif p.diff == 'Hard' %}hard{% endif %}">
                {{ p.diff | capitalize }}</div>
            <div class=" actions">
                <a id="edit" href="{{ url_for('edit_problem', id=p.id) }}">Edit</a>
                <a id="del" href="{{ url_for('delete_problem', id=p.id) }}"
                    onclick="return confirm('Are you sure you want to delete this problem?')">Delete</a>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="footer"></div>
</div>
{% endif %}




<script>

    window.onload = function () {
        refreshSlots("{{ problem_id }}"); // pass problem_id from Jinja

    }


    document.getElementById("searchButton").addEventListener("click", function (e) {

        e.preventDefault(); // prevent refresh

        let query = document.getElementById("searchBar").value.toLowerCase();
        let items = document.querySelectorAll("#list-container #listItem");

        items.forEach(item => {
            let title = item.querySelector(".TITLE").innerText.toLowerCase();
            if (title.includes(query)) {
                item.style.display = "grid"; // keep grid
            } else {
                item.style.display = "none";
            }
        });

        document.getElementById("searchBar").value = "";
    });
    async function refreshSlots(problemId) {
        try {


            const res = await fetch(`/problem/${problemId}`, { cache: "no-store" });
            if (!res.ok) throw new Error("Failed to fetch problem " + problemId);
            const payload = await res.json();

            const p = payload.problem || {};
            // Get form fields
            const title = document.getElementById("title");
            const desc = document.getElementById("description");
            const example = document.getElementById("example");
            const constraints = document.getElementById("constraints");
            const prefix = document.getElementById("prefix");
            const diff = p.diff;
            if (diff) {
                const radio = document.querySelector(`input[name="diff"][value="${diff}"]`);
                if (radio) radio.checked = true;
                console.log(diff)
            }

            // Fill values
            if (title) title.value = p.title || "";
            if (desc) desc.value = p.description || "";
            if (example) example.value = p.examples || "";
            if (constraints) constraints.value = p.constraints || "";
            if (prefix) prefix.value = p.prefix || "";
            const tagsEl = document.getElementById("tags");
            if (tagsEl) tagsEl.value = p.tags || "";



        } catch (err) {
            console.error("error:", err);
        }
    }
</script>

{% endblock %}