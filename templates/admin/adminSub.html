{% extends "admin/admin.html" %}
{% block title %}Submissions{% endblock %}

{% block style %}
<style>
    /* Container */
    #submission-container {
        max-width: 95%;
        margin: 20px auto;
        font-family: 'Lucida Sans', sans-serif;
        overflow-x: auto;
    }

    /* Header row */
    #submission-header {
        display: grid;
        grid-template-columns: 0.5fr 1fr 0.7fr 1fr 1fr 1.2fr 2fr 0.8fr 1fr 0.8fr 0.8fr 0.8fr;
        align-items: center;
        padding: 10px;
        gap: 10px;
        background-color: #2a2a2a;
        color: #e6e6e6;
        font-weight: bold;
        border-radius: 12px 12px 0 0;
    }

    /* Each submission row */
    .submission-row {
        display: grid;
        grid-template-columns: 0.5fr 1fr 0.7fr 1fr 1fr 1.2fr 2fr 0.8fr 1fr 0.8fr 0.8fr 0.8fr;
        gap: 10px;
        background-color: #1e1e1e;
        color: #ddd;
        margin-bottom: 2px;
        border-radius: 6px;
        padding: 10px;
        transition: all 0.3s ease;
        align-items: center;
        /* top-align for expanded panel */
    }

    /* Code/Error sections inside row with fade effect */
    .submission-row .sub-code,
    .submission-row .sub-error {
        position: relative;
        max-height: 100px;
        overflow: hidden;
        border-radius: 6px;
    }

    .submission-row .sub-code pre,
    .submission-row .sub-error pre {
        margin: 0;
        font-size: 13px;
        background-color: #262626;
        padding: 6px;
        border-radius: 6px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-word;
        height: 99999px;
    }

    .submission-row .sub-code::after,
    .submission-row .sub-error::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 30px;
        background: linear-gradient(to bottom, rgba(30, 30, 30, 0) 0%, rgba(30, 30, 30, 1) 100%);
        pointer-events: none;
    }

    /* Dropdown panel inside row, spans all columns */
    .dropdown-panel {
        display: none;
        background-color: #262626;
        color: #fff;
        padding: 10px;
        border-radius: 6px;
        font-size: 13px;
        white-space: pre-wrap;
        word-break: break-word;
        overflow-x: auto;
        grid-column: 1 / -1;
        margin-top: 10px;
    }

    /* Verdict colors */
    .verdict-memory-limit {
        color: #a16c90;
        font-weight: bold;
    }

    .verdict-correct {
        color: #2d8521;
        font-weight: bold;
    }

    .verdict-wrong {
        color: #852121;
        font-weight: bold;
    }

    .verdict-error {
        color: #f0a500;
        font-weight: bold;
    }

    .verdict-time-limit {
        color: #2d2d85;
        font-weight: bold;
    }

    .verdict-pending {
        color: #696a69;
        font-weight: bold;
    }

    /* Testcase links */
    .sub-tc a {
        background-color: #2d8521;
        color: #fff;
        padding: 4px 8px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 14px;
        display: inline-block;
        text-align: center;
    }

    .sub-tc a:hover {
        background-color: #1f5e17;
    }

    /* Expand button */
    .expand-btn {
        background-color: #2d8521;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 3px 8px;
        font-size: 14px;
        cursor: pointer;
        grid-column: 1 / -1;
        margin-top: 6px;
    }

    .expand-btn:hover {
        background-color: #1f5e17;
    }

    .dis-expand-btn {
        background-color: #929791;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 3px 8px;
        font-size: 14px;
        cursor: pointer;
        grid-column: 1 / -1;
        margin-top: 6px;
    }


    /* Responsive adjustments */
    @media screen and (max-width: 1024px) {

        #submission-header,
        .submission-row {
            grid-template-columns: 0.5fr 1fr 0.7fr 1fr 1fr 1.2fr 2fr 0.8fr 0.8fr 0.8fr;
        }
    }

    @media screen and (max-width: 768px) {

        #submission-header,
        .submission-row {
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            font-size: 13px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="submission-container">
    <h2>Recent Submissions</h2>

    <div id="submission-header">
        <div class="sub-ID">ID</div>
        <div class="sub-uniq">UniqID</div>
        <div class="sub-prob">Problem ID</div>
        <div class="sub-user">User</div>
        <div class="sub-verdict">Verdict</div>
        <div class="sub-time">Created At</div>
        <div class="sub-code">Source Code</div>
        <div class="sub-memory">Memory</div>
        <div class="sub-error">Error</div>
        <div class="sub-runtime">Runtime</div>
        <div class="sub-lang">Language</div>
        <div class="sub-tc">Actions</div>
    </div>

    {% for s in submissions %}
    <div class="submission-row" id="row-{{ s.subID }}">
        <div class="sub-ID">{{ s.subID }}</div>
        <div class="sub-uniq">{{ s.UniqID }}</div>
        <div class="sub-prob">{{ s.problem_id }}</div>
        <div class="sub-user">{{ s.userID }}</div>
        <div class="sub-verdict verdict-{{ s.status|lower|replace(' ', '-') }}">{{ s.status }}</div>
        <div class="sub-time">{{ s.subTime }}</div>

        <div class="sub-code">
            <pre>{{ s.code }}</pre>
        </div>
        <div class="sub-memory">{{ s.memory }} Bytes</div>
        <div class="sub-error">
            <pre>{{ s.error }}</pre>
        </div>
        <div class="sub-runtime">{{ s.runtime }}ms</div>
        <div class="sub-lang">{{ s.language }}</div>
        <div>
            <div class="sub-tc"><a href="{{ url_for('admin_SubTC', subId=s.UniqID) }}">See testcases</a></div>
            {% if s.error|length > 10 or s.code|length > 50 %}
            <button class="expand-btn" onclick="toggleDropdown('{{ s.subID }}', this)">Show full message</button>
            {% else %}
            <button class="dis-expand-btn">Show full message</button>
            {% endif %}
        </div>



        <div class="dropdown-panel" id="dropdown-{{ s.subID }}">
            <strong>Full Source Code:</strong>
            <pre>{{ s.code }}</pre>
            <strong>Error Message:</strong>
            <pre>{{ s.error }}</pre>
        </div>
    </div>
    {% endfor %}
</div>

<div id="sub-pagination">
    {% if total %}
    {% set total_pages = (total // per_page) + (1 if total % per_page else 0) %}
    <div style="display:flex; justify-content:center; gap:8px; padding:12px; flex-wrap:wrap;">
        {% if page > 1 %}
        <a class="add-btn" href="{{ url_for('adminSubmissions') }}?page={{ page-1 }}&per_page={{ per_page }}">Prev</a>
        {% endif %}

        {% for p in range(1, total_pages+1) %}
        {% if p == page %}
        <span class="add-btn" style="background:#3b82f6;">{{ p }}</span>
        {% else %}
        <a class="add-btn" href="{{ url_for('adminSubmissions') }}?page={{ p }}&per_page={{ per_page }}">{{ p }}</a>
        {% endif %}
        {% endfor %}

        {% if page < total_pages %} <a class="add-btn"
            href="{{ url_for('adminSubmissions') }}?page={{ page+1 }}&per_page={{ per_page }}">Next</a>
            {% endif %}
    </div>
    {% endif %}
</div>

<script>
    function toggleDropdown(subId, btn) {
        const panel = document.getElementById('dropdown-' + subId);
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
            btn.textContent = 'Show full message';
        } else {
            panel.style.display = 'block';
            btn.textContent = 'Hide full message';
        }
    }
</script>
{% endblock %}